<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body {
            height: 100%; /* Ensure html and body take full height */
            margin: 0;
            padding: 0;
            overflow: hidden; /* Crucial: Prevents overall page scrolling */
        }
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
    <!-- WS_URL_INJECTION_POINT -->
</head>
<!-- Body takes full screen height and removes default padding for mobile, adds for larger screens -->
<body class="bg-gray-100 flex items-center justify-center h-full">
    <!-- Main chat container: fullscreen on mobile, boxed and larger on medium+ screens -->
    <!-- h-full ensures it takes full viewport height, allowing flex-grow to work properly -->
    <div class="w-full h-full flex flex-col
                md:bg-white md:p-4 md:rounded-lg md:shadow-xl md:max-w-2xl md:h-[70vh]">

        <!-- Header - uses flex-shrink-0 to take only its content height -->
        <!-- px-4 for mobile horizontal padding, md:px-0 to remove it on desktop -->
        <div class="bg-white flex-shrink-0 px-4 md:px-0">
            <h1 class="text-2xl font-bold text-center text-gray-800 pt-4 md:py-0">Chat</h1>
            <!-- Container for client's avatar and ID -->
            <div id="clientInfo" class="flex items-center justify-center space-x-2 pb-4 md:pb-4">
                <!-- Placeholder for avatar and ID, will be populated by JS -->
                <img src="https://placehold.co/32x32/cccccc/ffffff?text=?" alt="Avatar" class="w-8 h-8 rounded-full">
                <span class="text-gray-600 text-sm">Connecting...</span>
            </div>
        </div>


        <!-- Messages area: grows to fill available space -->
        <!-- p-4 for consistent inner padding, rounded-none for mobile, rounded-lg for desktop -->
        <!-- pb-20 (80px) added to push content above the fixed input on mobile -->
        <div id="messages" class="border border-gray-300 rounded-none md:rounded-lg p-4 overflow-y-auto bg-gray-50 flex-grow pb-20 md:pb-4">
        </div>

        <!-- Input/Send Button Footer -->
        <!-- Fixed positioning for mobile, relative for desktop -->
        <!-- px-4 for mobile horizontal padding, pt-4 for mobile top padding -->
        <!-- pb-[env(safe-area-inset-bottom)] for iOS safe area -->
        <div class="fixed bottom-0 left-0 right-0 z-10 bg-white p-4
                    md:relative md:px-0 md:pb-0 md:rounded-b-lg">
            <div class="flex space-x-3">
                <input
                    type="text"
                    id="messageInput"
                    placeholder="Type your message..."
                    class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
                <button
                    id="sendButton"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50"
                >
                    Send
                </button>
            </div>
        </div>
    </div>

    <script>
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const clientInfoDiv = document.getElementById('clientInfo'); // Get the client info div

        const wsUrl = window.CHAT_WS_URL || 'ws://localhost:3000';
        const socket = new WebSocket(wsUrl);

        let myClientId = null;

        socket.onopen = (event) => {
            console.log('Connected to WebSocket server');
            appendMessage('System', 'Connected to chat!', 'system', 'text-green-600');
        };

        socket.onmessage = (event) => {
            const messageData = JSON.parse(event.data);

            if (messageData.type === 'init') {
                myClientId = messageData.clientId;
                console.log(`My client ID is: ${myClientId}`);
                // Update header with client's avatar and full ID
                clientInfoDiv.innerHTML = `
                    <img src="https://api.dicebear.com/9.x/glass/svg?seed=${myClientId}" alt="Your Avatar" class="w-8 h-8 rounded-full">
                    <span class="text-gray-600 text-sm font-medium">${myClientId}</span>
                `;
            } else if (messageData.type === 'chat') {
                if (messageData.senderId === myClientId) {
                    appendMessage('You', messageData.text, messageData.senderId, 'text-blue-600');
                } else {
                    appendMessage(messageData.senderId, messageData.text, messageData.senderId);
                }
            }
        };

        socket.onclose = (event) => {
            console.log('Disconnected from WebSocket server', event);
            appendMessage('System', 'Disconnected from chat.', 'system', 'text-red-600');
        };

        socket.onerror = (error) => {
            console.error('WebSocket error:', error);
            appendMessage('System', 'WebSocket error occurred.', 'system', 'text-red-600');
        };

        const sendMessage = () => {
            const message = messageInput.value.trim();
            if (message) {
                socket.send(message);
                messageInput.value = '';
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        };

        sendButton.addEventListener('click', sendMessage);

        messageInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        function appendMessage(senderName, messageText, senderId, colorClass = 'text-gray-800') {
            const messageContainer = document.createElement('div');
            messageContainer.classList.add('mb-2');

            const contentDiv = document.createElement('div');
            contentDiv.classList.add('break-words', 'flex-grow');

            let displayedSenderName = senderName;
            let titleAttribute = '';

            if (senderId !== 'system') {
                messageContainer.classList.add('flex', 'items-center', 'space-x-2');

                const avatarImg = document.createElement('img');
                avatarImg.src = `https://api.dicebear.com/9.x/glass/svg?seed=${senderId}`;
                avatarImg.alt = 'Avatar';
                avatarImg.classList.add('w-8', 'h-8', 'rounded-full', 'flex-shrink-0');
                messageContainer.appendChild(avatarImg);

                if (senderName !== 'You') {
                    displayedSenderName = senderId.substring(0, 8);
                    titleAttribute = `title="${senderId}"`;
                }
            }

            contentDiv.innerHTML = `<span class="font-semibold ${colorClass}" ${titleAttribute}>${displayedSenderName}:</span> ${messageText}`;

            messageContainer.appendChild(contentDiv);
            messagesDiv.appendChild(messageContainer);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    </script>
</body>
</html>
